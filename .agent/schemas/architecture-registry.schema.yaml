# Architecture Registry Schema (CAF v0.6.5)
#
# JSON Schema for validating architecture-registry blocks in architecture documents.
# Used by /architecture-validate to perform machine-checkable format validation.
#
# Location: .agent/schemas/architecture-registry.schema.yaml

$schema: "http://json-schema.org/draft-07/schema#"
$id: "https://caf.example.com/schemas/architecture-registry.schema.yaml"

title: "Architecture Registry"
description: "Schema for architecture-registry blocks in CAF v0.6.5+"
type: object

required:
  - schema_version
  - items

properties:
  schema_version:
    type: string
    pattern: "^v0\\.[6-9]\\.[0-9]+$|^v[1-9]\\.[0-9]+\\.[0-9]+$"
    description: "CAF schema version (v0.6.5+)"

  type:
    type: string
    enum:
      - overview
      - database
      - flows
      - api
    description: "Architecture document type"

  parent:
    type: string
    pattern: "^docs/L2/"
    description: "Parent L2 document path"

  items:
    type: array
    minItems: 1
    items:
      $ref: "#/definitions/ArchitectureItem"
    description: "List of architecture decisions"

definitions:
  ArchitectureItem:
    type: object
    required:
      - id
      - statement
      - sources
    properties:
      id:
        type: string
        pattern: "^ARCH-(OV|DB|FL|API)-[0-9]{3}$"
        description: "Architecture ID (ARCH-{TYPE}-NNN)"

      statement:
        type: string
        minLength: 10
        description: "Architecture decision statement"

      sources:
        type: array
        minItems: 1
        items:
          $ref: "#/definitions/SourceReference"
        description: "Traceability sources (REQ-* or IFC-*)"

      rationale:
        type: string
        description: "Decision rationale (recommended)"

      alternatives:
        type: array
        items:
          type: string
        description: "Considered alternatives (optional)"

      consequences:
        type: object
        properties:
          positive:
            type: array
            items:
              type: string
          negative:
            type: array
            items:
              type: string
        description: "Decision consequences (optional)"

  SourceReference:
    type: object
    required:
      - id
      - path
    properties:
      id:
        type: string
        pattern: "^(REQ-L[0-2]-[A-Z]+-[0-9]{3}|IFC-[A-Z]+-[A-Z]+)$"
        description: "Source ID (REQ-* or IFC-*)"

      path:
        type: string
        pattern: "^docs/(L[0-2]/|architecture/)"
        description: "Source file path with anchor"

# Validation Examples
#
# Valid:
# ```architecture-registry
# schema_version: "v0.6.5"
# type: "database"
# parent: "docs/L2/api-server/requirements.md"
# items:
#   - id: ARCH-DB-001
#     statement: "使用 PostgreSQL + pgvector 存储向量"
#     sources:
#       - id: "REQ-L2-API-001"
#         path: "docs/L2/api-server/requirements.md#REQ-L2-API-001"
#     rationale: "满足 RAG 检索需求"
# ```
#
# Invalid (missing sources):
# ```architecture-registry
# items:
#   - id: ARCH-DB-001
#     statement: "使用 PostgreSQL"
#     # ERROR: sources is required
# ```
